---
# Copyright 2024 Sophos Ltd.  All rights reserved.
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: SOPHOS FIREWALL CERTIFICATE MANAGEMENT TESTING
  hosts: all
  gather_facts: false
  
  vars:
    # Test certificate content for upload testing
    test_certificate_content: |
      -----BEGIN CERTIFICATE-----
      MIIDyjCCArICCQCiXmMJsU/2EDANBgkqhkiG9w0BAQsFADCBpjELMAkGA1UEBhMC
      VVMxEzARBgNVBAgMCkNhbGlmb3JuaWExFjAUBgNVBAcMDVNhbiBGcmFuY2lzY28x
      GjAYBgNVBAoMEVRlc3QgT3JnYW5pemF0aW9uMRIwEAYDVQQLDAlUZXN0IFVuaXQx
      GTAXBgNVBAMMEHRlc3QuZXhhbXBsZS5jb20xHzAdBgkqhkiG9w0BCQEWEHRlc3RA
      ZXhhbXBsZS5jb20wHhcNMjUxMDAyMTg0ODM2WhcNMjYxMDAyMTg0ODM2WjCBpjEL
      MAkGA1UEBhMCVVMxEzARBgNVBAgMCkNhbGlmb3JuaWExFjAUBgNVBAcMDVNhbiBG
      cmFuY2lzY28xGjAYBgNVBAoMEVRlc3QgT3JnYW5pemF0aW9uMRIwEAYDVQQLDAlU
      ZXN0IFVuaXQxGTAXBgNVBAMMEHRlc3QuZXhhbXBsZS5jb20xHzAdBgkqhkiG9w0B
      CQEWEHRlc3RAZXhhbXBsZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
      AoIBAQDAHxOBiJaQLvnyANKSgPp8gJOWVSbjvJv2vkAS8TXsy3fl0UgRu8Fz0LM+
      JM+twnZ4eQLCSNePhHY9Qa17rWtIkvFsTV89gYakEi65plZt7zbvLfKW3BCGgEdP
      Uz1/7JZM4l8MGnMKSkwltzux5Nkcz3a1H5QoI5QB+lIsjOBpd5zM1fZcJ/sD9NsK
      T8f0W9RHyAON+56a7tVJBHuBijb8ndzjmUY2DMMrEBOLAb0Bwp1ryd7mYUSK6AHd
      hBeJYuRc+PPTuN/2nZHt+ro/Z5W3zo8k7LaO4tMU/4asVjPiQgSLIwsCUljET1UX
      ebuGVVE3QRq8ej9iCYsBUkGco8BDAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAGRX
      0djitWZh21oinAqpr1ymVp/w6FQfye8P33YbNWg1bxJfHHmnhv1h6EVfAz4ehvYw
      0xrhuD9QEJD7m6ual07VKGPUJYplFDJZpoVql7s3GQ/8CXTmd60YEieVjeZ+kGEx
      bW8+nJbjGBDoeTQIsaw7BIO82pWWn6P3WarUCPWxuaFWhAijBR0n4ysIFOXZWfW6
      4LaPKxIfVcHZOEPgMm/SwIivX5r9sjQIseHN/fWtL5p8/um1TOtWwxBqCRJgDwZh
      uiw/y7GPC5GZoxbwJhFA4G/kPBTiIG/TKdkTxPQY3hQQTc0Z5Lf7+GVjobFHeeIN
      Lx72icSDR6OGLJUbnX4=
      -----END CERTIFICATE-----

    test_private_key_content: |
      -----BEGIN PRIVATE KEY-----
      MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDAHxOBiJaQLvny
      ANKSgPp8gJOWVSbjvJv2vkAS8TXsy3fl0UgRu8Fz0LM+JM+twnZ4eQLCSNePhHY9
      Qa17rWtIkvFsTV89gYakEi65plZt7zbvLfKW3BCGgEdPUz1/7JZM4l8MGnMKSkwl
      tzux5Nkcz3a1H5QoI5QB+lIsjOBpd5zM1fZcJ/sD9NsKT8f0W9RHyAON+56a7tVJ
      BHuBijb8ndzjmUY2DMMrEBOLAb0Bwp1ryd7mYUSK6AHdhBeJYuRc+PPTuN/2nZHt
      +ro/Z5W3zo8k7LaO4tMU/4asVjPiQgSLIwsCUljET1UXebuGVVE3QRq8ej9iCYsB
      UkGco8BDAgMBAAECggEBAIssN+InAwLRtOh1ZhUQ7+OO9Nr7Nl/VOpokuZ+/MpQl
      1OYbk/ycqYfvUFkdK4CxFUcySihZwiXKDClV0Yl9V/FL2S3eYrbYhKOINGbyMzwS
      BRaAj3JvWl1EweOZ5jwsM7jgZ4AKDPoQVlcgBFNa91hihZixlo75Lve70RlKuCpN
      ZO1tqJRaVKi03ja5KDLgmNrF8doqBZEjHf906ovD2xmxdmF5enHwHfSIfLuQVRnj
      WuTA7hTI0nhrCvtDlgReyh3de1Lmq/c0PNq35C5NjZGSQ+txwF9h10eF8qgcjriA
      59Mn9dMCst5RuDFsKTE1/xz28e71TL5fm5wjl1YRb3kCgYEA6pKytN/XfPSP8cCI
      JzWPeTQzm9ugjygHb5swlrb1UXtLyOr1oJxg+14NKfj0KdopcbkBGL4P+uV+oBPB
      KEwcqBP28ar8XoHkaqEkZ3k0cqsUfXGtIsV4uuqKNNtH9oQlRRwBwjyDyO+Xaiiz
      WONk8l8P4xF7B1rI5yC6Q5KN1wKBgQDT2b3yVbGNm3xJw8zOlO9KKnC9fWy4hRqQ
      UGF5TKsJ8sGKlzQ3x4yD7rF5sN8tLmVkJq2mCxJyF8Y3KwQ5A7rL9mN4oP6Q8sR1
      -----END PRIVATE KEY-----

  tasks:

    #=========================================
    # CERTIFICATE UPLOAD TESTS
    #=========================================

    - name: CREATE TEMPORARY CERTIFICATE FILE
      ansible.builtin.copy:
        content: "{{ test_certificate_content }}"
        dest: /tmp/manual_test_certificate.pem
      delegate_to: localhost
      tags:
        - upload
        - setup

    - name: CREATE TEMPORARY PRIVATE KEY FILE
      ansible.builtin.copy:
        content: "{{ test_private_key_content }}"
        dest: /tmp/manual_test_private_key.pem
      delegate_to: localhost
      tags:
        - upload
        - setup

    - name: UPLOAD CERTIFICATE WITH PRIVATE KEY
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_UPLOAD_CERT
        action: UploadCertificate
        certificate_file: /tmp/manual_test_certificate.pem
        private_key_file: /tmp/manual_test_private_key.pem
        certificate_password: ""
        state: present
      register: upload_result
      tags:
        - upload

    - name: DISPLAY UPLOAD RESULT
      ansible.builtin.debug:
        var: upload_result
      tags:
        - upload

    - name: QUERY UPLOADED CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_UPLOAD_CERT
        state: query
      register: query_upload_result
      tags:
        - upload
        - query

    - name: DISPLAY UPLOADED CERTIFICATE DETAILS
      ansible.builtin.debug:
        var: query_upload_result.api_response.Response.Certificate
      tags:
        - upload
        - query

    #=========================================
    # SELF-SIGNED CERTIFICATE TESTS
    #=========================================

    - name: GENERATE BASIC SELF-SIGNED CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_SELFSIGNED_BASIC
        action: GenerateSelfSignedCertificate
        common_name: manual-basic.example.com
        organization_name: Manual Test Organization
        country_name: US
        key_type: RSA
        key_length: 2048
        secure_hash: "SHA - 256"
        valid_from: "2025-01-01"
        valid_upto: "2026-12-31"
        state: present
      register: selfsigned_basic_result
      tags:
        - selfsigned

    - name: DISPLAY BASIC SELF-SIGNED CERTIFICATE RESULT
      ansible.builtin.debug:
        var: selfsigned_basic_result
      tags:
        - selfsigned

    - name: GENERATE ADVANCED SELF-SIGNED CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_SELFSIGNED_ADVANCED
        action: GenerateSelfSignedCertificate
        common_name: manual-advanced.example.com
        organization_name: Advanced Manual Test Organization
        organization_unit_name: IT Department
        country_name: US
        state_province_name: California
        locality_name: San Francisco
        email_address: manual-test@example.com
        key_type: RSA
        key_length: 4096
        secure_hash: "SHA - 512"
        valid_from: "2025-01-01"
        valid_upto: "2027-12-31"
        dns_name:
          - manual-advanced.example.com
          - www.manual-advanced.example.com
          - api.manual-advanced.example.com
        ip_address:
          - "192.168.100.100"
          - "10.0.100.100"
        state: present
      register: selfsigned_advanced_result
      tags:
        - selfsigned
        - advanced

    - name: DISPLAY ADVANCED SELF-SIGNED CERTIFICATE RESULT
      ansible.builtin.debug:
        var: selfsigned_advanced_result
      tags:
        - selfsigned
        - advanced

    - name: GENERATE ELLIPTIC CURVE SELF-SIGNED CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_SELFSIGNED_EC
        action: GenerateSelfSignedCertificate
        common_name: manual-ec.example.com
        organization_name: EC Manual Test Organization
        country_name: US
        email_address: ec-manual@example.com
        key_type: "Elliptic Curve"
        curve_name: secp384r1
        secure_hash: "SHA - 384"
        valid_from: "2025-01-01"
        valid_upto: "2026-12-31"
        state: present
      register: selfsigned_ec_result
      tags:
        - selfsigned
        - ec

    - name: DISPLAY ELLIPTIC CURVE SELF-SIGNED CERTIFICATE RESULT
      ansible.builtin.debug:
        var: selfsigned_ec_result
      tags:
        - selfsigned
        - ec

    #=========================================
    # CSR (Certificate Signing Request) TESTS
    #=========================================

    - name: GENERATE BASIC CSR
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_CSR_BASIC
        action: GenerateCSR
        common_name: manual-csr-basic.example.com
        organization_name: Manual CSR Test Organization
        country_name: US
        key_type: RSA
        key_length: 2048
        secure_hash: "SHA - 256"
        state: present
      register: csr_basic_result
      tags:
        - csr

    - name: DISPLAY BASIC CSR RESULT
      ansible.builtin.debug:
        var: csr_basic_result
      tags:
        - csr

    - name: GENERATE ADVANCED CSR WITH SUBJECT ALTERNATIVE NAMES
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_CSR_ADVANCED
        action: GenerateCSR
        common_name: manual-csr-advanced.example.com
        organization_name: Advanced CSR Manual Test Organization
        organization_unit_name: Security Department
        country_name: US
        state_province_name: New York
        locality_name: New York City
        email_address: csr-manual@example.com
        key_type: RSA
        key_length: 4096
        secure_hash: "SHA - 512"
        dns_name:
          - manual-csr-advanced.example.com
          - www.manual-csr-advanced.example.com
          - secure.manual-csr-advanced.example.com
        ip_address:
          - "203.0.113.100"
          - "198.51.100.100"
        state: present
      register: csr_advanced_result
      tags:
        - csr
        - advanced

    - name: DISPLAY ADVANCED CSR RESULT
      ansible.builtin.debug:
        var: csr_advanced_result
      tags:
        - csr
        - advanced

    - name: GENERATE ELLIPTIC CURVE CSR
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_CSR_EC
        action: GenerateCSR
        common_name: manual-csr-ec.example.com
        organization_name: EC CSR Manual Test Organization
        country_name: CA
        email_address: ec-csr-manual@example.com
        key_type: "Elliptic Curve"
        curve_name: secp256r1
        secure_hash: "SHA - 256"
        state: present
      register: csr_ec_result
      tags:
        - csr
        - ec

    - name: DISPLAY ELLIPTIC CURVE CSR RESULT
      ansible.builtin.debug:
        var: csr_ec_result
      tags:
        - csr
        - ec

    #=========================================
    # LET'S ENCRYPT CERTIFICATE TESTS
    #=========================================

    - name: REQUEST LET'S ENCRYPT CERTIFICATE (BASIC)
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_LETSENCRYPT_BASIC
        action: RequestLetsEncryptCertificate
        domain_name: manual-le-basic.example.com
        challenge_type: HTTP-01
        email_address: letsencrypt-manual@example.com
        state: present
      register: letsencrypt_basic_result
      tags:
        - letsencrypt
      # Note: This will likely fail in testing environment as it requires real domain validation

    - name: DISPLAY LET'S ENCRYPT BASIC RESULT
      ansible.builtin.debug:
        var: letsencrypt_basic_result
      tags:
        - letsencrypt

    - name: REQUEST LET'S ENCRYPT CERTIFICATE WITH MULTIPLE DOMAINS
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_LETSENCRYPT_MULTI
        action: RequestLetsEncryptCertificate
        domain_name: manual-le-multi.example.com
        challenge_type: DNS-01
        email_address: letsencrypt-multi-manual@example.com
        dns_name:
          - manual-le-multi.example.com
          - www.manual-le-multi.example.com
        state: present
      register: letsencrypt_multi_result
      tags:
        - letsencrypt
        - multi
      # Note: This will likely fail in testing environment as it requires real domain validation

    - name: DISPLAY LET'S ENCRYPT MULTI-DOMAIN RESULT
      ansible.builtin.debug:
        var: letsencrypt_multi_result
      tags:
        - letsencrypt
        - multi

    #=========================================
    # CERTIFICATE QUERY AND MANAGEMENT TESTS
    #=========================================

    - name: QUERY ALL CERTIFICATES
      sophos.sophos_firewall.sfos_certificate:
        state: query
      register: all_certificates_result
      tags:
        - query
        - all

    - name: DISPLAY ALL CERTIFICATES
      ansible.builtin.debug:
        var: all_certificates_result.api_response.Response.Certificate
      tags:
        - query
        - all

    - name: QUERY SPECIFIC CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_SELFSIGNED_BASIC
        state: query
      register: specific_cert_result
      tags:
        - query
        - specific

    - name: DISPLAY SPECIFIC CERTIFICATE DETAILS
      ansible.builtin.debug:
        var: specific_cert_result.api_response.Response.Certificate
      tags:
        - query
        - specific

    #=========================================
    # CERTIFICATE REMOVAL TESTS
    #=========================================

    - name: REMOVE UPLOADED CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_UPLOAD_CERT
        state: absent
      register: remove_upload_result
      tags:
        - remove
        - upload

    - name: DISPLAY REMOVE UPLOADED CERTIFICATE RESULT
      ansible.builtin.debug:
        var: remove_upload_result
      tags:
        - remove
        - upload

    - name: REMOVE BASIC SELF-SIGNED CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_SELFSIGNED_BASIC
        state: absent
      register: remove_selfsigned_result
      tags:
        - remove
        - selfsigned

    - name: DISPLAY REMOVE SELF-SIGNED CERTIFICATE RESULT
      ansible.builtin.debug:
        var: remove_selfsigned_result
      tags:
        - remove
        - selfsigned

    - name: REMOVE ADVANCED SELF-SIGNED CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_SELFSIGNED_ADVANCED
        state: absent
      tags:
        - remove
        - selfsigned
        - advanced

    - name: REMOVE ELLIPTIC CURVE SELF-SIGNED CERTIFICATE
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_SELFSIGNED_EC
        state: absent
      tags:
        - remove
        - selfsigned
        - ec

    - name: REMOVE BASIC CSR
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_CSR_BASIC
        state: absent
      tags:
        - remove
        - csr

    - name: REMOVE ADVANCED CSR
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_CSR_ADVANCED
        state: absent
      tags:
        - remove
        - csr
        - advanced

    - name: REMOVE ELLIPTIC CURVE CSR
      sophos.sophos_firewall.sfos_certificate:
        name: MANUAL_CSR_EC
        state: absent
      tags:
        - remove
        - csr
        - ec

    #=========================================
    # CLEANUP TASKS
    #=========================================

    - name: CLEANUP TEMPORARY CERTIFICATE FILE
      ansible.builtin.file:
        path: /tmp/manual_test_certificate.pem
        state: absent
      delegate_to: localhost
      tags:
        - cleanup
        - always

    - name: CLEANUP TEMPORARY PRIVATE KEY FILE
      ansible.builtin.file:
        path: /tmp/manual_test_private_key.pem
        state: absent
      delegate_to: localhost
      tags:
        - cleanup
        - always